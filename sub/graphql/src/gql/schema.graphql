#
# Copyright 2016 Minder Labs.
#

#
# http://graphql.org/learn/schema
# https://facebook.github.io/graphql
#

#===================================================================================================
# Item.
# TODO(burdon): Move common fields into meta?
# http://dev.apollodata.com/tools/graphql-tools/resolvers.html#Unions-and-interfaces
# https://github.com/apollostack/graphql-server/issues/172
#===================================================================================================

interface Item {
  namespace: String           # External namespace (query provider).
  bucket: ID                  # ID of User or Group (null for system item).
  type: String!
  id: ID!
  # TODO(burdon): Multiple.
  fkey: String                # Foreign key.
  alias: String               # Short-name for URLs (unique, human-readable).
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]
}

#===================================================================================================
# System Types.
#===================================================================================================

type User implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  active: Boolean

  # TODO(burdon): Part of contact?
  email: String

  # TODO(burdon): Bi-directional.
  contact: Contact

  # TODO(burdon): Remove (only query via project links).
  tasks(filter: FilterInput): [Task]!

  groups: [Group]
}

type Group implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  whitelist: [String]
  members: [User]!

  # TODO(burdon): Shouldn't be part of Group (i.e., span namespaces). Instead link (since many-to-may).
  projects: [Project]!
}

#===================================================================================================
# Item Types.
#===================================================================================================

type Contact implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  email: String

  user: User

  # TODO(burdon): Implement as links.
  tasks: [Task]!
}

type Document implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  # TODO(burdon): Move url, iconUrl, thumbnailUrl to ItemFragment
  url: String
  iconUrl: String
  thumbnailUrl: String
}

type Event implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  location: Place
  participants: [Contact]
}

type Folder implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  icon: String

  # JSON serialized FilterInput.
  filter: String!
}

type Place implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  geo: Geo
}

type Project implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  # TODO(burdon): Might not be associted with a Group (e.g., private Project).
  group: Group!

  # TODO(burdon): Directives for links. Other items (e.g., Contacts board).
  # And/or add a FilterInput param here.
  tasks: [Task]!

  # TODO(burdon): Map type (array of typed values).
  boards: [Board]
}

type Task implements Item {
  namespace: String
  bucket: ID
  type: String!
  id: ID!
  fkey: String
  alias: String
  created: Timestamp!
  modified: Timestamp!
  title: String!
  description: String
  labels: [String]

  # TODO(burdon): Implement via links?
  project: Project

  # Sub-tasks.
  # TODO(burdon): Resolver should flatten the query to return the hierarchical set?
  tasks: [Task]!

  owner: User!
  assignee: User
  status: Int!
}

#===================================================================================================
# Root Viewer for authenticated User.
#===================================================================================================

type Client {

  id: String!
}

type Viewer {

  # Authenticated user.
  user: User!

  # All Groups User belongs to.
  groups: [Group]

  # Folders.
  folders: [Folder]!
}

#===================================================================================================
# Queries.
# NOTE: Must only have Input types (since regular types might be recursive and therefore not serializable).
# https://github.com/graphql/graphql-js/issues/312
#===================================================================================================

type RootQuery {

  # Current user.
  viewer: Viewer!

  # Get specific.
  # TODO(burdon): Namespace.
  # TODO(burdon): Return multiple items.
  # TODO(burdon): Add basic ItemStore key-range lookup.
  item(itemId: ID!): Item!

  # Search.
  search(filter: FilterInput, offset: Int, count: Int): [Item]!
}

#===================================================================================================
# Mutations.
# NOTE: The namespace is provided in the resolver context.
#===================================================================================================

input ItemMutationInput {

  # Item to mutate.
  itemId: ID!

  # Array of generic mutations.
  mutations: [ObjectMutationInput]!
}

type RootMutation {

  # Generic mutations.
  upsertItems(namespace: String, mutations: [ItemMutationInput]!): [Item]!
}

#===================================================================================================
# Schema.
#===================================================================================================

schema {

  query: RootQuery

  mutation: RootMutation
}
